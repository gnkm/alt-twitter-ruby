# 📝 プロダクト仕様書

**目的**：Rails API／Next.js／MySQL／Redisを使ったフルスタック構成の最小実装例

---

## 1. 概要

本システムは、ユーザーが短文の投稿（ツイート）を行い、全ユーザーの投稿を時系列で一覧表示できるシンプルなWebアプリケーションです。
ログインやフォロー機能は省略し、**グローバルタイムライン**のみを提供します。

---

## 2. システム構成

| 層       | 技術                       | 用途                                        |
| ------- | ------------------------ | ----------------------------------------- |
| フロントエンド | **Next.js (TypeScript)** | 投稿フォーム・投稿一覧の表示（SSR＋CSR）                   |
| デザイン | **Tailwind CSS + shadcn/ui + lucide-react** | UI コンポーネントの作成 |
| APIサーバ  | **Rails 7 APIモード**       | 投稿登録・一覧取得                                 |
| データベース  | **MySQL**                | 投稿データの永続化                                 |
| キャッシュ層  | **Redis**                | 最新投稿のキャッシュ、投稿数カウンタ                        |
| 開発環境    | Docker Compose           | `frontend`, `api`, `db`, `redis` の4サービス構成 |

### SSR / CSR

| 部分          | 技術      | 理由                    |
| ----------- | ------- | --------------------- |
| 初期タイムライン    | **SSR** | 高速表示＋SEO＋Redisキャッシュ活用 |
| 投稿フォーム      | **CSR** | 非同期POST＋即時反映          |
| 自動更新（ポーリング） | **CSR** | 軽量更新・SWR対応しやすい        |


---

## 3. 機能一覧

| 機能        | 概要                    |
| --------- | --------------------- |
| 投稿作成      | テキストを投稿し、DBに保存        |
| 投稿一覧      | 全投稿を新しい順に取得・表示        |
| 投稿キャッシュ   | Redisに最新投稿IDを保存し、高速表示 |

---

## 4. 画面仕様（Next.js側）

### `/` トップページ（投稿＋タイムライン）

| 要素     | 内容                              |
| ------ | ------------------------------- |
| 投稿フォーム | テキスト入力＋投稿ボタン（送信でRails APIにPOST） |
| タイムライン | 直近50件の投稿を新しい順に表示                |
| 投稿要素   | ユーザー名（固定“guest”）・本文・投稿時間        |
| 自動更新   | 10秒ごとにAPI再取得（簡易リアルタイム）          |

---

## 5. API仕様（Rails側）

### `POST /api/posts`

**投稿を作成**

#### リクエスト

```json
{
  "body": "こんにちは、世界！"
}
```

#### レスポンス（201）

```json
{
  "id": 1,
  "body": "こんにちは、世界！",
  "author_name": "guest",
  "created_at": "2025-11-09T13:00:00Z"
}
```

#### 処理内容

1. バリデーション（空文字を弾く）
2. MySQLに保存
3. Redisに`LPUSH tl:global post_id`で最新投稿をキャッシュ
4. Redisで`INCR stats:post_count`を更新

---

### `GET /api/posts`

**投稿一覧取得**

#### クエリ

`?limit=50` （デフォルト50件）

#### レスポンス（200）

```json
[
  {
    "id": 10,
    "body": "テスト投稿10",
    "author_name": "guest",
    "created_at": "2025-11-09T13:10:00Z"
  },
  ...
]
```

#### 処理内容

1. Redisの`tl:global`から最新50件のIDを取得
2. IDリストをもとにMySQLで投稿データをフェッチ（降順）
3. Redisキャッシュが足りなければDBから補完

---

## 6. データベース設計

**posts テーブル**

| カラム         | 型           | 説明            |
| ----------- | ----------- | ------------- |
| id          | bigint      | 主キー           |
| body        | text        | 投稿内容（最大140文字） |
| author_name | varchar(32) | ユーザー名（今回は固定）  |
| created_at  | datetime    | 投稿日時          |
| updated_at  | datetime    | 更新日時          |

インデックス：`created_at DESC`（一覧用）

---

## 7. Redisキー設計

| キー                 | 用途                | 例                 |
| ------------------ | ----------------- | ----------------- |
| `tl:global`        | 最新投稿IDのリスト（最大50件） | `[10, 9, 8, ...]` |

---

## 8. エラーハンドリング

| 状況           | ステータス | メッセージ例                                      |
| ------------ | ----- | ------------------------------------------- |
| bodyが空       | 422   | `{ "error": "Body can't be blank" }`        |
| bodyが141文字以上 | 422   | `{ "error": "Body is too long (max 140)" }` |
| サーバーエラー      | 500   | `{ "error": "Internal server error" }`      |

---

## 9. 非機能要件

| 項目      | 内容                             |
| ------- | ------------------------------ |
| パフォーマンス | Redisからのキャッシュヒット率80%以上を目標      |
| 安定性     | 投稿時のDBトランザクションを明示              |
| 品質保証    | 最低1件のRSpec＋Nextの単体テストを追加       |
| デプロイ想定  | ローカルDocker Composeで完結可（クラウド不要） |
